document.addEventListener('DOMContentLoaded', function () {
    // Loading screen
    const loadingScreen = document.getElementById('loading');

    function hideLoadingScreen() {
        loadingScreen.style.opacity = '0';
        setTimeout(function () {
            loadingScreen.style.display = 'none';
        }, 500);
    }

    // Check if the page has already loaded
    if (document.readyState === 'complete') {
        hideLoadingScreen();
    } else {
        window.addEventListener('load', hideLoadingScreen);
    }

    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });

    // Active navigation item highlighting
    const sections = document.querySelectorAll("section");
    const navItems = document.querySelectorAll(".nav-item");

    window.addEventListener("scroll", () => {
        let current = "";
        sections.forEach((section) => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (pageYOffset >= sectionTop - sectionHeight / 3) {
                current = section.getAttribute("id");
            }
        });

        navItems.forEach((item) => {
            item.classList.remove("active");
            if (item.querySelector("a").getAttribute("href").slice(1) === current) {
                item.classList.add("active");
            }
        });
        
        // Show/hide scroll-to-top button
        if (window.pageYOffset > 300) {
            scrollToTopBtn.style.display = "block";
        } else {
            scrollToTopBtn.style.display = "none";
        }
    });

    // Populate key findings
    const keyFindings = [
        "Identified over 100 unique bioactive compounds across 29 plant species",
        "Discovered potential new sources of antioxidants and anti-inflammatory agents",
        "Uncovered novel compounds with promising anticancer properties",
        "Found plant extracts with significant antimicrobial activity against drug-resistant pathogens"
    ];

    const keyFindingsList = document.getElementById('keyFindings');
    keyFindings.forEach(finding => {
        const li = document.createElement('li');
        li.textContent = finding;
        keyFindingsList.appendChild(li);
    });

    // Dynamic plant gallery population with lightbox and filtering
    const plantGallery = document.getElementById('plantGallery');
    const plantSpecies = [
        // Lamiaceae Family
        { name: 'Ocimum tenuiflorum L. Subtype Rama', image: 'plants/HM.jpg', family: 'Lamiaceae' },
        { name: 'Ocimum gratissimum L.', image: 'plants/GT.jpg', family: 'Lamiaceae' },
        { name: 'Hyptis suaveolens (L.) Poit.', image: 'plants/AT.jpg', family: 'Lamiaceae' },
        { name: 'Ocimum tenuiflorum L. Subtype Krishna', image: 'plants/TL.jpg', family: 'Lamiaceae' },
        { name: 'Plectranthus barbatus (Andrews) Benth. ex G.Don', image: 'plants/WK.jpg', family: 'Lamiaceae' },
        { name: 'Plectranthus zatarhendi E.A. Bruce', image: 'plants/IW.jpg', family: 'Lamiaceae' },
        { name: 'Anisomeles indica (L.) Kuntze', image: 'plants/YW.jpg', family: 'Lamiaceae' },
        // Rutaceae Family
        { name: 'Atalantia ceylanica (Arn.) Oliv.', image: 'plants/YN.jpg', family: 'Rutaceae' },
        { name: 'Citrus aurantifolia aurantifolia L.', image: 'plants/DH.jpg', family: 'Rutaceae' },
        { name: 'Acronychia pedunculata (L.) Miq.', image: 'plants/AK.jpg', family: 'Rutaceae' },
        { name: 'Citrus madurensis Lour.', image: 'plants/NN.jpg', family: 'Rutaceae' },
        { name: 'Citrus sinensis (L.) Osbeck', image: 'plants/PD.jpg', family: 'Rutaceae' },
        { name: 'Citrus reticulata L.', image: 'plants/HN.jpg', family: 'Rutaceae' },
        { name: 'Aegle marmelos (L.) Correa', image: 'plants/BL.jpg', family: 'Rutaceae' },
        { name: 'Toddalia asiatica (L.) Lam.', image: 'plants/KM.jpg', family: 'Rutaceae' },
        { name: 'Clausena indica (Dalzell) Oliv.', image: 'plants/MK.jpg', family: 'Rutaceae' },
        { name: 'Ruta chalepensis L.', image: 'plants/AR.jpg', family: 'Rutaceae' },
        { name: 'Limonia acidissima L.', image: 'plants/DV.jpg', family: 'Rutaceae' },
        // Lauraceae Family
        { name: 'Cinnamomum verum J.Presl', image: 'plants/KR.jpg', family: 'Lauraceae' },
        // Poaceae Family
        { name: 'Cymbopogon citratus (DC.) Stapf', image: 'plants/SR.jpg', family: 'Poaceae' },
        // Asteraceae Family
        { name: 'Ageratum conyzoides L.', image: 'plants/HT.jpg', family: 'Asteraceae' },
        { name: 'Tithonia diversifolia (Hemsl.) A.gray', image: 'plants/WS.jpg', family: 'Asteraceae' },        
        // Apiaceae Family
        { name: 'Eryngium foetidum L.', image: 'plants/AN.jpg', family: 'Apiaceae' },
        // Euphorbiaceae Family
        { name: 'Croton laccifer L.', image: 'plants/KP.jpg', family: 'Euphorbiaceae' },
        // Piperaceae Family
        { name: 'Piper betle L.', image: 'plants/BU.jpg', family: 'Piperaceae' },
        // Verbenaceae Family
        { name: 'Vitex negundo L.', image: 'plants/NK.jpg', family: 'Verbenaceae' },
        // Magnoliaceae Family
        { name: 'Michelia champaca (L.) Baill. ex Pierre', image: 'plants/GS.jpg', family: 'Magnoliaceae' },
        // Convolvulaceae Family
        { name: 'Evolvulus alsinoides (L.) L.', image: 'plants/NV.jpg', family: 'Convolvulaceae' }
    ];

    // Populate the plant gallery dynamically
    plantSpecies.forEach((plant) => {
        const plantCard = document.createElement('div');
        plantCard.classList.add('plant-card');
        plantCard.setAttribute('data-family', plant.family);
        
        const nameParts = plant.name.split(' ');
        const italicizedName = nameParts.map((part, index) => index < 2 ? `<i>${part}</i>` : part).join(' ');

        plantCard.innerHTML = `
            <img src="${plant.image}" alt="${plant.name}">
            <p>${italicizedName}</p>
        `;
        plantGallery.appendChild(plantCard);
    });

    // Lightbox functionality
    const lightbox = document.querySelector('.lightbox');
    const lightboxImg = lightbox.querySelector('img');
    const lightboxCaption = lightbox.querySelector('.lightbox-caption');
    const closeLightboxBtn = document.querySelector('.close-lightbox');

    function openLightbox(imgSrc, caption) {
        lightboxImg.src = imgSrc;
        lightboxCaption.innerHTML = caption;
        lightbox.style.display = 'block';
        setTimeout(() => {
            lightbox.style.opacity = '1';
            lightbox.style.transform = 'translateX(0)';
        }, 50);
    }

    function closeLightbox() {
        lightbox.style.opacity = '0';
        lightbox.style.transform = 'translateX(100%)';
        setTimeout(() => {
            lightbox.style.display = 'none';
            lightboxImg.src = '';
        }, 500);
    }

    document.querySelectorAll('.plant-card').forEach(card => {
        card.addEventListener('click', () => {
            const imgSrc = card.querySelector('img').src;
            const caption = card.querySelector('p').innerHTML;
            openLightbox(imgSrc, caption);
        });
    });

    closeLightboxBtn.addEventListener('click', closeLightbox);

    // Family filter functionality
    const filterButtons = document.querySelectorAll('.filter-button');
    const plantCards = document.querySelectorAll('.plant-card');

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const family = button.getAttribute('data-family');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            plantCards.forEach(card => {
                card.style.display = card.getAttribute('data-family') === family || family === 'all' ? 'block' : 'none';
            });
        });
    });

    // Collapsible navigation menu
    const navToggle = document.querySelector('.nav-toggle');
    const navLinks = document.querySelector('.nav-links');

    navToggle.addEventListener('click', function () {
        navLinks.classList.toggle('show');
    });

    // Close menu when a link is clicked (for mobile)
    navLinks.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            navLinks.classList.remove('show');
        });
    });
  
    // Phytochemical Dashboard
    const compounds = [
        "Analgesic", "AntiInflammatory", "Anticancer", "Sedative", "Antimicrobial",
        "Antioxidant", "Antispasmodic", "Antiviral", "Anxiolytic", "Bronchodilator",
        "Gastroprotective", "Neuroprotective", "Anticonvulsant", "Antidiabetic", "Antihistamine"
    ];

    function createDashboard() {
        const dashboardSection = document.createElement('section');
        dashboardSection.id = 'phytochemical-dashboard';
        dashboardSection.className = 'phytochemical-dashboard-section';

        const title = document.createElement('h2');
        title.textContent = 'Bioactive Compounds';
        title.className = 'dashboard-title';

        const description = document.createElement('p');
        description.textContent = 'Explore the detailed analysis of various bioactive compounds found in Sri Lankan underexploited plants, categorized by their medicinal properties. Created using ploty in Python.';
        description.className = 'dashboard-description';

        const tabList = document.createElement('div');
        tabList.className = 'tab-list';

        const plotContainer = document.createElement('div');
        plotContainer.className = 'plot-container';

        compounds.forEach((compound, index) => {
            const tab = document.createElement('button');
            tab.textContent = `${compound} Compounds`;
            tab.className = 'tab-button';
            if (index === 0) tab.classList.add('active');

            tab.addEventListener('click', () => switchTab(compound));
            tabList.appendChild(tab);
        });

        dashboardSection.appendChild(title);
        dashboardSection.appendChild(description);
        dashboardSection.appendChild(tabList);
        dashboardSection.appendChild(plotContainer);

        // Insert the dashboard before the plant gallery section
        const plantGallery = document.getElementById('plant-gallery');
        if (plantGallery) {
            plantGallery.parentNode.insertBefore(dashboardSection, plantGallery);
        } else {
            console.warn('Plant gallery section not found. Appending dashboard to body.');
            document.body.appendChild(dashboardSection);
        }

        // Load the first plot by default
        switchTab(compounds[0]);
    }

    function switchTab(compound) {
        const plotContainer = document.querySelector('.plot-container');
        plotContainer.innerHTML = ''; // Clear previous plot

        const iframe = document.createElement('iframe');
        iframe.src = `https://munu832.github.io/Phytochemistry_of_Sri_Lankan_Underexploited_Plants/Stack%20Plots/${compound.toLowerCase()}_compounds_in_medicinal_plants_stacked_area.html`;
        iframe.className = 'plot-iframe';
        iframe.title = `${compound} Compounds`;
        iframe.setAttribute('aria-description', `Stacked area plot showing ${compound} compounds in medicinal plants`);

        iframe.onerror = () => {
            plotContainer.innerHTML = `<p>Failed to load ${compound} compounds plot. Please try again later.</p>`;
        };

        plotContainer.appendChild(iframe);

        // Update active tab
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
            if (button.textContent === `${compound} Compounds`) {
                button.classList.add('active');
            }
        });
    }

    createDashboard();

    // Scroll to top button
    const scrollToTopBtn = document.createElement('button');
    scrollToTopBtn.innerHTML = '↑';
    scrollToTopBtn.classList.add('scroll-to-top');
    document.body.appendChild(scrollToTopBtn);

    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
});
